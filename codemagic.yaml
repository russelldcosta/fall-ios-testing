workflows:
  unity-ios-build:
    name: Unity 6 iOS Build
    max_build_duration: 120
    instance_type: mac_mini_m2
    environment:
      groups:
        - unity
      vars:
        # Confirmed version from your project
        UNITY_VERSION: "6000.2.6f2" 
    scripts:
      - name: Install Unity Engine (Virtual Env Method)
        script: |
          set -e # Exit immediately if any command fails
          
          echo "1. Creating a fresh Python Virtual Environment..."
          # Create a folder named 'venv' in the current directory
          python3 -m venv venv
          
          # Activate it (this forces the system to use THIS folder for everything)
          source venv/bin/activate
          
          echo "2. Installing codemagic-cli-tools into the isolated environment..."
          # Install the tool specifically into this folder
          pip install codemagic-cli-tools
          
          echo "3. Verifying the installer exists..."
          # We know exactly where it is now: venv/bin/unity-installer
          INSTALLER="./venv/bin/unity-installer"
          
          if [ ! -f "$INSTALLER" ]; then
            echo "CRITICAL: Installer still not found in venv. Listing venv/bin:"
            ls -l venv/bin
            exit 1
          fi
          
          echo "4. Running Unity Installer..."
          # Run the tool from our known location
          $INSTALLER --version $UNITY_VERSION --platform ios
          
      - name: Locate Unity
        script: |
          # Finds the newly installed Unity binary
          UNITY_BIN=$(find /Applications/Unity/Hub/Editor -name "Unity" -type f -path "*/Contents/MacOS/Unity" | head -n 1)
          if [ -z "$UNITY_BIN" ]; then
            echo "Unity not found after install! Check if version $UNITY_VERSION matches the installed folder."
            ls -R /Applications/Unity/Hub/Editor
            exit 1
          fi
          echo "export UNITY_BIN=\"$UNITY_BIN\"" >> $CM_ENV
          echo "Unity located at: $UNITY_BIN"
      - name: Create Editor Folder and Build Script
        script: |
          mkdir -p Assets/Editor
          cat <<EOF > Assets/Editor/BuildScript.cs
          using UnityEditor;
          public class BuildScript {
              public static void BuildIOS() {
                  BuildPlayerOptions options = new BuildPlayerOptions();
                  // Ensure this matches your Scene name exactly
                  options.scenes = new[] { "Assets/Scenes/SampleScene.unity" }; 
                  options.locationPathName = "build/ios";
                  options.target = BuildTarget.iOS;
                  options.options = BuildOptions.None;
                  BuildPipeline.BuildPlayer(options);
              }
          }
          EOF
      - name: Build Xcode Project
        script: |
          "$UNITY_BIN" \
            -batchmode \
            -quit \
            -projectPath . \
            -executeMethod BuildScript.BuildIOS \
            -buildTarget iOS \
            -logFile /dev/stdout
      - name: Build Unsigned App
        script: |
          cd build/ios
          xcodebuild -project Unity-iPhone.xcodeproj \
            -scheme Unity-iPhone \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            build
    artifacts:
      - build/ios/build/Release-iphoneos/*.app